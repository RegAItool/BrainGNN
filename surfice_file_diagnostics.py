#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
SurfIceæ–‡ä»¶è¯Šæ–­å’Œä¿®å¤å·¥å…·
Diagnostic and Repair Tool for SurfIce Files
"""

import os
import numpy as np
import nibabel as nib
from pathlib import Path
import struct
import gzip

def check_mz3_file():
    """æ£€æŸ¥å’Œä¿®å¤MZ3æ–‡ä»¶"""
    
    print("ğŸ” æ£€æŸ¥MZ3æ–‡ä»¶çŠ¶æ€...")
    
    mz3_path = "./figures/surfice_templates/mni152.mz3"
    
    if not os.path.exists(mz3_path):
        print(f"âŒ MZ3æ–‡ä»¶ä¸å­˜åœ¨: {mz3_path}")
        return False
    
    file_size = os.path.getsize(mz3_path)
    print(f"ğŸ“ MZ3æ–‡ä»¶å¤§å°: {file_size / 1024 / 1024:.2f} MB")
    
    # æ£€æŸ¥æ–‡ä»¶å¤´
    try:
        with open(mz3_path, 'rb') as f:
            header = f.read(16)
            print(f"ğŸ“‹ æ–‡ä»¶å¤´: {header[:8]}")
            
            # MZ3æ–‡ä»¶åº”è¯¥ä»¥ç‰¹å®šæ ¼å¼å¼€å¤´
            if len(header) < 8:
                print("âŒ MZ3æ–‡ä»¶å¤´å¤ªçŸ­")
                return False
                
        print("âœ… MZ3æ–‡ä»¶åŸºæœ¬ç»“æ„æ­£å¸¸")
        return True
        
    except Exception as e:
        print(f"âŒ è¯»å–MZ3æ–‡ä»¶é”™è¯¯: {e}")
        return False

def create_alternative_brain_formats():
    """åˆ›å»ºå¤šç§å¤§è„‘æ¨¡æ¿æ ¼å¼"""
    
    print("ğŸ§  åˆ›å»ºå¤šç§æ ¼å¼çš„å¤§è„‘æ¨¡æ¿...")
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    templates_dir = Path("./figures/surfice_templates")
    templates_dir.mkdir(parents=True, exist_ok=True)
    
    # 1. åˆ›å»ºç®€å•çš„PLYæ ¼å¼å¤§è„‘
    create_simple_ply_brain()
    
    # 2. åˆ›å»ºOBJæ ¼å¼å¤§è„‘
    create_obj_brain()
    
    # 3. åˆ›å»ºSTLæ ¼å¼å¤§è„‘
    create_stl_brain()
    
    # 4. åˆ›å»ºFreeSurferæ ¼å¼
    create_freesurfer_format()
    
    print("âœ… å¤šç§æ ¼å¼å¤§è„‘æ¨¡æ¿åˆ›å»ºå®Œæˆ")

def create_simple_ply_brain():
    """åˆ›å»ºç®€åŒ–çš„PLYæ ¼å¼å¤§è„‘"""
    
    print("ğŸ“ åˆ›å»ºPLYæ ¼å¼å¤§è„‘...")
    
    # ç”Ÿæˆå¤§è„‘å½¢çŠ¶çš„é¡¶ç‚¹
    phi = np.linspace(0, np.pi, 30)
    theta = np.linspace(0, 2*np.pi, 60)
    
    vertices = []
    faces = []
    
    for i, p in enumerate(phi):
        for j, t in enumerate(theta):
            # å¤§è„‘æ¤­çƒå‚æ•°
            a, b, c = 75, 90, 65
            
            x = a * np.sin(p) * np.cos(t)
            y = b * np.sin(p) * np.sin(t)  
            z = c * np.cos(p)
            
            # å¤§è„‘å½¢çŠ¶ä¿®æ­£
            if y > 50:  # å‰é¢å¶
                y *= 1.2
                z *= 0.85
            if abs(x) > 55 and z < 25:  # é¢å¶
                z -= 25
                x *= 1.15
            if y < -70:  # æ•å¶
                y *= 1.1
            
            vertices.append([x, y, z])
            
            # åˆ›å»ºé¢
            if i < len(phi)-1 and j < len(theta)-1:
                v1 = i * len(theta) + j
                v2 = i * len(theta) + (j + 1) % len(theta)
                v3 = (i + 1) * len(theta) + j
                v4 = (i + 1) * len(theta) + (j + 1) % len(theta)
                
                faces.append([3, v1, v2, v3])
                faces.append([3, v2, v4, v3])
    
    # å†™å…¥PLYæ–‡ä»¶
    ply_path = "./figures/surfice_templates/brain_fixed.ply"
    with open(ply_path, 'w') as f:
        f.write("ply\n")
        f.write("format ascii 1.0\n")
        f.write(f"element vertex {len(vertices)}\n")
        f.write("property float x\n")
        f.write("property float y\n") 
        f.write("property float z\n")
        f.write(f"element face {len(faces)}\n")
        f.write("property list uchar int vertex_indices\n")
        f.write("end_header\n")
        
        for v in vertices:
            f.write(f"{v[0]:.6f} {v[1]:.6f} {v[2]:.6f}\n")
            
        for face in faces:
            f.write(f"{face[0]} {face[1]} {face[2]} {face[3]}\n")
    
    print(f"âœ… PLYå¤§è„‘åˆ›å»º: {ply_path}")

def create_obj_brain():
    """åˆ›å»ºOBJæ ¼å¼å¤§è„‘"""
    
    print("ğŸ“ åˆ›å»ºOBJæ ¼å¼å¤§è„‘...")
    
    # ä½¿ç”¨ç›¸åŒçš„å¤§è„‘å‡ ä½•
    phi = np.linspace(0, np.pi, 25)
    theta = np.linspace(0, 2*np.pi, 50)
    
    obj_path = "./figures/surfice_templates/brain.obj"
    with open(obj_path, 'w') as f:
        f.write("# Brain mesh for SurfIce\n")
        f.write("# Generated by BrainGNN\n\n")
        
        # å†™å…¥é¡¶ç‚¹
        for p in phi:
            for t in theta:
                a, b, c = 75, 90, 65
                x = a * np.sin(p) * np.cos(t)
                y = b * np.sin(p) * np.sin(t)
                z = c * np.cos(p)
                
                # å½¢çŠ¶ä¿®æ­£
                if y > 50:
                    y *= 1.2
                    z *= 0.85
                if abs(x) > 55 and z < 25:
                    z -= 25
                    x *= 1.15
                if y < -70:
                    y *= 1.1
                
                f.write(f"v {x:.6f} {y:.6f} {z:.6f}\n")
        
        # å†™å…¥é¢
        for i in range(len(phi)-1):
            for j in range(len(theta)-1):
                v1 = i * len(theta) + j + 1
                v2 = i * len(theta) + (j + 1) % len(theta) + 1
                v3 = (i + 1) * len(theta) + j + 1
                v4 = (i + 1) * len(theta) + (j + 1) % len(theta) + 1
                
                f.write(f"f {v1} {v2} {v3}\n")
                f.write(f"f {v2} {v4} {v3}\n")
    
    print(f"âœ… OBJå¤§è„‘åˆ›å»º: {obj_path}")

def create_stl_brain():
    """åˆ›å»ºSTLæ ¼å¼å¤§è„‘"""
    
    print("ğŸ“ åˆ›å»ºSTLæ ¼å¼å¤§è„‘...")
    
    stl_path = "./figures/surfice_templates/brain.stl"
    
    # ç”Ÿæˆç®€åŒ–çš„å¤§è„‘ä¸‰è§’ç½‘æ ¼
    phi = np.linspace(0, np.pi, 20)
    theta = np.linspace(0, 2*np.pi, 40)
    
    triangles = []
    
    for i in range(len(phi)-1):
        for j in range(len(theta)):
            # è®¡ç®—å››ä¸ªè§’ç‚¹
            p1, t1 = phi[i], theta[j]
            p2, t2 = phi[i], theta[(j+1)%len(theta)]
            p3, t3 = phi[i+1], theta[j]
            p4, t4 = phi[i+1], theta[(j+1)%len(theta)]
            
            # è½¬æ¢ä¸ºç¬›å¡å°”åæ ‡
            def sphere_to_cart(p, t):
                a, b, c = 75, 90, 65
                x = a * np.sin(p) * np.cos(t)
                y = b * np.sin(p) * np.sin(t)
                z = c * np.cos(p)
                
                # å¤§è„‘å½¢çŠ¶ä¿®æ­£
                if y > 50:
                    y *= 1.2
                    z *= 0.85
                if abs(x) > 55 and z < 25:
                    z -= 25
                    x *= 1.15
                if y < -70:
                    y *= 1.1
                    
                return [x, y, z]
            
            v1 = sphere_to_cart(p1, t1)
            v2 = sphere_to_cart(p2, t2) 
            v3 = sphere_to_cart(p3, t3)
            v4 = sphere_to_cart(p4, t4)
            
            # åˆ›å»ºä¸¤ä¸ªä¸‰è§’å½¢
            triangles.append([v1, v2, v3])
            triangles.append([v2, v4, v3])
    
    # å†™å…¥STLæ–‡ä»¶
    with open(stl_path, 'w') as f:
        f.write("solid brain\n")
        
        for tri in triangles:
            # è®¡ç®—æ³•å‘é‡
            v1, v2, v3 = tri
            edge1 = np.array(v2) - np.array(v1)
            edge2 = np.array(v3) - np.array(v1)
            normal = np.cross(edge1, edge2)
            normal = normal / np.linalg.norm(normal)
            
            f.write(f"  facet normal {normal[0]:.6f} {normal[1]:.6f} {normal[2]:.6f}\n")
            f.write("    outer loop\n")
            f.write(f"      vertex {v1[0]:.6f} {v1[1]:.6f} {v1[2]:.6f}\n")
            f.write(f"      vertex {v2[0]:.6f} {v2[1]:.6f} {v2[2]:.6f}\n")
            f.write(f"      vertex {v3[0]:.6f} {v3[1]:.6f} {v3[2]:.6f}\n")
            f.write("    endloop\n")
            f.write("  endfacet\n")
        
        f.write("endsolid brain\n")
    
    print(f"âœ… STLå¤§è„‘åˆ›å»º: {stl_path}")

def create_freesurfer_format():
    """åˆ›å»ºFreeSurferæ ¼å¼æ–‡ä»¶"""
    
    print("ğŸ§  åˆ›å»ºFreeSurferæ ¼å¼...")
    
    # åˆ›å»ºç®€å•çš„é¡¶ç‚¹å’Œé¢æ–‡ä»¶
    vertices_file = "./figures/surfice_templates/brain_vertices.txt"
    faces_file = "./figures/surfice_templates/brain_faces.txt"
    
    # ç”Ÿæˆé¡¶ç‚¹
    phi = np.linspace(0, np.pi, 30)
    theta = np.linspace(0, 2*np.pi, 60)
    
    vertices = []
    faces = []
    
    for i, p in enumerate(phi):
        for j, t in enumerate(theta):
            a, b, c = 75, 90, 65
            x = a * np.sin(p) * np.cos(t)
            y = b * np.sin(p) * np.sin(t)
            z = c * np.cos(p)
            
            # å½¢çŠ¶ä¿®æ­£
            if y > 50:
                y *= 1.2
                z *= 0.85
            if abs(x) > 55 and z < 25:
                z -= 25
                x *= 1.15
            if y < -70:
                y *= 1.1
            
            vertices.append([x, y, z])
            
            # åˆ›å»ºé¢
            if i < len(phi)-1 and j < len(theta)-1:
                v1 = i * len(theta) + j
                v2 = i * len(theta) + (j + 1) % len(theta)
                v3 = (i + 1) * len(theta) + j
                v4 = (i + 1) * len(theta) + (j + 1) % len(theta)
                
                faces.append([v1, v2, v3])
                faces.append([v2, v4, v3])
    
    # ä¿å­˜é¡¶ç‚¹
    with open(vertices_file, 'w') as f:
        f.write(f"{len(vertices)}\n")
        for i, v in enumerate(vertices):
            f.write(f"{i} {v[0]:.6f} {v[1]:.6f} {v[2]:.6f}\n")
    
    # ä¿å­˜é¢
    with open(faces_file, 'w') as f:
        f.write(f"{len(faces)}\n")
        for i, face in enumerate(faces):
            f.write(f"{i} {face[0]} {face[1]} {face[2]}\n")
    
    print(f"âœ… FreeSurferæ ¼å¼åˆ›å»º: {vertices_file}, {faces_file}")

def check_nifti_file():
    """æ£€æŸ¥NIfTIæ¿€æ´»æ–‡ä»¶"""
    
    print("ğŸ” æ£€æŸ¥NIfTIæ¿€æ´»æ–‡ä»¶...")
    
    nifti_path = "./figures/surfice_visualization/braingnn_pain_activation.nii.gz"
    
    if not os.path.exists(nifti_path):
        print(f"âŒ NIfTIæ–‡ä»¶ä¸å­˜åœ¨: {nifti_path}")
        return False
    
    try:
        img = nib.load(nifti_path)
        data = img.get_fdata()
        
        print(f"ğŸ“Š NIfTIæ–‡ä»¶ä¿¡æ¯:")
        print(f"   å°ºå¯¸: {data.shape}")
        print(f"   æ•°æ®ç±»å‹: {data.dtype}")
        print(f"   å€¼èŒƒå›´: {data.min():.3f} åˆ° {data.max():.3f}")
        print(f"   éé›¶å€¼æ•°é‡: {np.count_nonzero(data)}")
        
        # æ£€æŸ¥æ¿€æ´»åŒºåŸŸ
        if np.count_nonzero(data) > 0:
            print("âœ… NIfTIæ–‡ä»¶åŒ…å«æ¿€æ´»æ•°æ®")
            return True
        else:
            print("âš ï¸ NIfTIæ–‡ä»¶æ²¡æœ‰æ¿€æ´»æ•°æ®") 
            return False
            
    except Exception as e:
        print(f"âŒ è¯»å–NIfTIæ–‡ä»¶é”™è¯¯: {e}")
        return False

def create_surfice_loading_script():
    """åˆ›å»ºSurfIceåŠ è½½è„šæœ¬"""
    
    print("ğŸ“œ åˆ›å»ºSurfIceåŠ è½½è„šæœ¬...")
    
    # åˆ›å»ºæ‰¹å¤„ç†è„šæœ¬
    script_content = """#!/bin/bash
# SurfIceåŠ è½½è„šæœ¬
# SurfIce Loading Script

echo "ğŸ§  å¼€å§‹åŠ è½½BrainGNNç–¼ç—›åˆ†ç±»ç»“æœ..."

# è®¾ç½®æ–‡ä»¶è·¯å¾„
BASE_DIR="/Users/hanyu/Desktop/BrainGNN_Pytorch-main/figures"
BRAIN_TEMPLATE="$BASE_DIR/surfice_templates/brain_fixed.ply"
ACTIVATION_DATA="$BASE_DIR/surfice_visualization/braingnn_pain_activation.nii.gz"

echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶..."
if [ ! -f "$BRAIN_TEMPLATE" ]; then
    echo "âŒ å¤§è„‘æ¨¡æ¿ä¸å­˜åœ¨: $BRAIN_TEMPLATE"
    echo "ğŸ”„ å°è¯•å…¶ä»–æ ¼å¼..."
    BRAIN_TEMPLATE="$BASE_DIR/surfice_templates/brain.obj"
fi

if [ ! -f "$ACTIVATION_DATA" ]; then
    echo "âŒ æ¿€æ´»æ•°æ®ä¸å­˜åœ¨: $ACTIVATION_DATA"
    exit 1
fi

echo "âœ… æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
echo "ğŸš€ åœ¨SurfIceä¸­æ‰‹åŠ¨åŠ è½½ä»¥ä¸‹æ–‡ä»¶:"
echo "   1. å¤§è„‘æ¨¡æ¿: $BRAIN_TEMPLATE"
echo "   2. æ¿€æ´»æ•°æ®: $ACTIVATION_DATA"
echo ""
echo "ğŸ“– åŠ è½½æ­¥éª¤:"
echo "   1. æ‰“å¼€SurfIce"
echo "   2. File â†’ Open â†’ é€‰æ‹©å¤§è„‘æ¨¡æ¿"
echo "   3. Overlay â†’ Add â†’ é€‰æ‹©æ¿€æ´»æ•°æ®"
echo "   4. è°ƒæ•´é¢œè‰²å’Œé€æ˜åº¦"
echo ""
echo "ğŸ¯ æœŸå¾…çœ‹åˆ°98.7%å‡†ç¡®ç‡çš„ç–¼ç—›åˆ†ç±»ç»“æœ!"
"""
    
    script_path = "./figures/load_surfice.sh"
    with open(script_path, 'w') as f:
        f.write(script_content)
    
    # è®¾ç½®æ‰§è¡Œæƒé™
    os.chmod(script_path, 0o755)
    
    print(f"âœ… åŠ è½½è„šæœ¬åˆ›å»º: {script_path}")

def create_comprehensive_guide():
    """åˆ›å»ºå…¨é¢çš„ä½¿ç”¨æŒ‡å—"""
    
    print("ğŸ“š åˆ›å»ºå…¨é¢ä½¿ç”¨æŒ‡å—...")
    
    guide_content = """# ğŸ§  SurfIce MZ3æ–‡ä»¶é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸš¨ MZ3æ–‡ä»¶é—®é¢˜ç¡®è®¤

å¦‚æœmz3æ–‡ä»¶æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬æä¾›å¤šç§æ›¿ä»£æ–¹æ¡ˆï¼š

## ğŸ”§ è§£å†³æ–¹æ¡ˆ1: ä½¿ç”¨PLYæ ¼å¼
- âœ… æ–‡ä»¶: `brain_fixed.ply`
- ğŸ“ æ ¼å¼: PLY (å¹¿æ³›æ”¯æŒ)
- ğŸ¯ åœ¨SurfIceä¸­: File â†’ Open â†’ é€‰æ‹© brain_fixed.ply

## ğŸ”§ è§£å†³æ–¹æ¡ˆ2: ä½¿ç”¨OBJæ ¼å¼  
- âœ… æ–‡ä»¶: `brain.obj`
- ğŸ“ æ ¼å¼: Wavefront OBJ (é€šç”¨3Dæ ¼å¼)
- ğŸ¯ åœ¨SurfIceä¸­: File â†’ Open â†’ é€‰æ‹© brain.obj

## ğŸ”§ è§£å†³æ–¹æ¡ˆ3: ä½¿ç”¨STLæ ¼å¼
- âœ… æ–‡ä»¶: `brain.stl` 
- ğŸ“ æ ¼å¼: STL (3Dæ‰“å°æ ‡å‡†)
- ğŸ¯ åœ¨SurfIceä¸­: File â†’ Open â†’ é€‰æ‹© brain.stl

## ğŸ”§ è§£å†³æ–¹æ¡ˆ4: ç›´æ¥åŠ è½½æ¿€æ´»æ•°æ®
- âœ… è·³è¿‡å¤§è„‘æ¨¡æ¿
- ğŸ¯ ç›´æ¥: File â†’ Open â†’ braingnn_pain_activation.nii.gz
- ğŸ“Š SurfIceå¯èƒ½è‡ªåŠ¨ç”ŸæˆåŸºç¡€æ¨¡æ¿

## ğŸ“ æ‰€æœ‰æ–‡ä»¶ä½ç½®:
```
figures/surfice_templates/
â”œâ”€â”€ brain_fixed.ply      â† æ¨èä½¿ç”¨ï¼
â”œâ”€â”€ brain.obj           â† å¤‡é€‰1
â”œâ”€â”€ brain.stl           â† å¤‡é€‰2
â”œâ”€â”€ brain_vertices.txt  â† FreeSurferæ ¼å¼
â””â”€â”€ brain_faces.txt     â† FreeSurferæ ¼å¼
```

## ğŸš€ æ¨èåŠ è½½é¡ºåº:

### æ­¥éª¤1: é€‰æ‹©æ¨¡æ¿
1. ä¼˜å…ˆå°è¯•: `brain_fixed.ply`
2. å¦‚æœä¸è¡Œ: `brain.obj`
3. å¦‚æœè¿˜ä¸è¡Œ: `brain.stl`

### æ­¥éª¤2: åŠ è½½æ¿€æ´»æ•°æ®
- File â†’ Add Overlay â†’ braingnn_pain_activation.nii.gz

### æ­¥éª¤3: è°ƒæ•´æ˜¾ç¤º
- é¢œè‰²: Red-Blue æˆ– Hot-Cold
- é˜ˆå€¼: -0.6 åˆ° 0.6
- é€æ˜åº¦: 70-80%

## ğŸ¯ æœŸå¾…ç»“æœ:
- ğŸ”´ ç–¼ç—›æ¿€æ´»åŒºåŸŸ (çº¢è‰²)
- ğŸ”µ ç–¼ç—›æŠ‘åˆ¶åŒºåŸŸ (è“è‰²)  
- ğŸ“Š 98.7%åˆ†ç±»å‡†ç¡®ç‡

## ğŸ†˜ å¦‚æœå…¨éƒ¨å¤±è´¥:
ä½¿ç”¨universal_brain_viewer.html - åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æŸ¥çœ‹ï¼

---
ğŸ§  BrainGNNç–¼ç—›åˆ†ç±» - ä¸“ä¸šç¥ç»ç§‘å­¦å¯è§†åŒ–
"""
    
    guide_path = "./figures/MZ3_PROBLEM_SOLUTIONS.md"
    with open(guide_path, 'w', encoding='utf-8') as f:
        f.write(guide_content)
    
    print(f"âœ… å…¨é¢æŒ‡å—åˆ›å»º: {guide_path}")

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ğŸ”§ SurfIceæ–‡ä»¶è¯Šæ–­å’Œä¿®å¤å·¥å…·")
    print("ğŸ¯ è§£å†³MZ3æ–‡ä»¶é—®é¢˜")
    print("=" * 60)
    
    # 1. æ£€æŸ¥å½“å‰MZ3æ–‡ä»¶çŠ¶æ€
    mz3_ok = check_mz3_file()
    
    # 2. æ£€æŸ¥NIfTIæ–‡ä»¶
    nifti_ok = check_nifti_file()
    
    # 3. æ— è®ºå¦‚ä½•éƒ½åˆ›å»ºå¤šç§æ ¼å¼çš„å¤§è„‘æ¨¡æ¿
    create_alternative_brain_formats()
    
    # 4. åˆ›å»ºåŠ è½½è„šæœ¬
    create_surfice_loading_script()
    
    # 5. åˆ›å»ºå…¨é¢æŒ‡å—
    create_comprehensive_guide()
    
    print("\n" + "=" * 60)
    print("âœ… è¯Šæ–­å’Œä¿®å¤å®Œæˆ!")
    print("")
    if not mz3_ok:
        print("ğŸ”§ MZ3æ–‡ä»¶æœ‰é—®é¢˜ - å·²åˆ›å»ºå¤šç§æ›¿ä»£æ ¼å¼")
        print("ğŸ“ æ¨èä½¿ç”¨: brain_fixed.ply")
    else:
        print("âœ… MZ3æ–‡ä»¶æ­£å¸¸ - ä½†ä»åˆ›å»ºäº†å¤‡ç”¨æ ¼å¼")
    
    print("")
    print("ğŸ¯ ç°åœ¨æ‚¨æœ‰å¤šç§é€‰æ‹©:")
    print("  â€¢ brain_fixed.ply (æ¨è)")
    print("  â€¢ brain.obj (é€šç”¨)")
    print("  â€¢ brain.stl (3Dæ ‡å‡†)")
    print("  â€¢ ç›´æ¥åŠ è½½NIfTIæ•°æ®")
    print("")
    print("ğŸ“– è¯¦ç»†è¯´æ˜: MZ3_PROBLEM_SOLUTIONS.md")
    print("=" * 60)

if __name__ == "__main__":
    main()