<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic 3D Brain Pain Analysis</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0c0c0c, #1a1a2e);
            font-family: 'Arial', sans-serif;
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #brain3d {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #brain3d:active {
            cursor: grabbing;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .control-section {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
        }
        
        .control-section:last-child {
            border-bottom: none;
        }
        
        .control-section h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
            font-size: 14px;
        }
        
        .slider-container {
            margin: 8px 0;
        }
        
        .slider-container label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            outline: none;
        }
        
        input[type="checkbox"], input[type="radio"] {
            margin-right: 8px;
        }
        
        .region-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 350px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            min-height: 120px;
        }
        
        .region-info h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
        }
        
        .stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            min-width: 80px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 18px;
        }
        
        .legend {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 12px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .brain-slice {
            position: absolute;
            opacity: 0.3;
            pointer-events: none;
        }
        
        .brain-mesh {
            opacity: 0.1;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
</head>
<body>
    <div class="container">
        <div id="brain3d"></div>
        
        <div class="ui-overlay">
            <div class="header">
                <h1>üß† Realistic 3D Brain Pain Analysis</h1>
                <p>FC+GNN Explainable Analysis | Model Accuracy: 98.7%</p>
            </div>
            
            <div class="controls">
                <div class="control-section">
                    <h3>üéõÔ∏è View Controls</h3>
                    <div class="slider-container">
                        <label>Brain Opacity:</label>
                        <input type="range" id="brainOpacity" min="0" max="0.3" value="0.1" step="0.01">
                    </div>
                    <div class="slider-container">
                        <label>Region Size:</label>
                        <input type="range" id="regionSize" min="0.5" max="3" value="1" step="0.1">
                    </div>
                    <div class="slider-container">
                        <label>Glow Intensity:</label>
                        <input type="range" id="glowIntensity" min="0" max="2" value="1" step="0.1">
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>üîç Display Options</h3>
                    <label><input type="checkbox" id="showBrainMesh" checked> Brain Surface</label><br>
                    <label><input type="checkbox" id="showTopKOnly" checked> Top-K Only</label><br>
                    <label><input type="checkbox" id="showConnections"> Connections</label><br>
                    <label><input type="checkbox" id="autoRotate"> Auto Rotate</label>
                </div>
                
                <div class="control-section">
                    <h3>üé® Visualization Mode</h3>
                    <label><input type="radio" name="colorMode" value="activation" checked> Pain Activation</label><br>
                    <label><input type="radio" name="colorMode" value="importance"> Importance</label><br>
                    <label><input type="radio" name="colorMode" value="network"> Networks</label><br>
                    <label><input type="radio" name="colorMode" value="statistical"> P-value</label>
                </div>
                
                <div class="control-section">
                    <h3>üìä Analysis Info</h3>
                    <div style="font-size: 11px;">
                        <strong>Method:</strong> FC+GNN Analysis<br>
                        <strong>Atlas:</strong> AAL116<br>
                        <strong>Attention:</strong> 8-head structural<br>
                        <strong>Selection:</strong> Top-K ranking
                    </div>
                </div>
            </div>
            
            <div class="legend">
                <h3 style="margin: 0 0 10px 0; color: #ffd700; font-size: 14px;">Legend</h3>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ff4444;"></div>
                    <span>Enhanced</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #4444ff;"></div>
                    <span>Suppressed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ffd700;"></div>
                    <span>Top-K</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: transparent; border: 2px solid #fff;"></div>
                    <span>Connections</span>
                </div>
            </div>
            
            <div class="region-info">
                <h3>Region Information</h3>
                <div id="selectedRegion">
                    <p><strong>Click on any brain region to view details</strong></p>
                    <p>This visualization shows the 3D spatial distribution of brain regions involved in pain processing, mapped to real MNI coordinates.</p>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value">15</div>
                    <div>Top-K</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">36</div>
                    <div>Regions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">98.7%</div>
                    <div>Accuracy</div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <p>üß† Loading realistic brain model...</p>
        </div>
    </div>

    <script>
        // Brain regions with real MNI coordinates
        const brainRegions = [
            {name: "Precentral_L", mni: [-38, -6, 52], activation: -0.433, importance: 0.013, network: "sensorimotor", topK: true, type: "suppressed"},
            {name: "Precentral_R", mni: [40, -6, 52], activation: 0.000, importance: 0.001, network: "sensorimotor", topK: false, type: "neutral"},
            {name: "Postcentral_L", mni: [-40, -26, 52], activation: 0.000437, importance: 2.525, network: "sensorimotor", topK: true, type: "enhanced"},
            {name: "Postcentral_R", mni: [42, -26, 52], activation: 0.000155, importance: 0.915, network: "sensorimotor", topK: true, type: "enhanced"},
            {name: "Frontal_Sup_L", mni: [-22, 28, 50], activation: -0.512, importance: 0.015, network: "cognitive_control", topK: true, type: "suppressed"},
            {name: "Frontal_Sup_R", mni: [24, 28, 50], activation: -0.394, importance: 0.011, network: "cognitive_control", topK: true, type: "suppressed"},
            {name: "Frontal_Mid_L", mni: [-32, 46, 30], activation: -0.498, importance: 0.014, network: "cognitive_control", topK: true, type: "suppressed"},
            {name: "Frontal_Mid_R", mni: [34, 46, 30], activation: 0.000141, importance: 0.317, network: "cognitive_control", topK: true, type: "enhanced"},
            {name: "Parietal_Sup_L", mni: [-26, -58, 52], activation: 0.15, importance: 0.02, network: "attention", topK: false, type: "enhanced"},
            {name: "Parietal_Sup_R", mni: [28, -58, 52], activation: 0.0, importance: 0.082, network: "attention", topK: true, type: "suppressed"},
            {name: "Occipital_Mid_L", mni: [-30, -88, 8], activation: 0.385, importance: 0.016, network: "visual", topK: false, type: "enhanced"},
            {name: "Occipital_Mid_R", mni: [32, -88, 8], activation: 0.528, importance: 0.022, network: "visual", topK: true, type: "enhanced"},
            {name: "Occipital_Sup_L", mni: [-18, -88, 18], activation: 0.0, importance: 0.001, network: "visual", topK: false, type: "neutral"},
            {name: "Occipital_Sup_R", mni: [20, -88, 18], activation: 0.528, importance: 0.022, network: "visual", topK: false, type: "enhanced"},
            {name: "Temporal_Sup_L", mni: [-54, -18, 6], activation: -0.389, importance: 0.014, network: "auditory", topK: false, type: "suppressed"},
            {name: "Temporal_Sup_R", mni: [56, -18, 6], activation: 0.0, importance: 0.001, network: "auditory", topK: false, type: "neutral"},
            {name: "Cerebelum_Crus1_L", mni: [-34, -78, -30], activation: 0.438, importance: 0.016, network: "cerebellar", topK: true, type: "enhanced"},
            {name: "Cerebelum_Crus1_R", mni: [36, -78, -30], activation: 0.601, importance: 0.022, network: "cerebellar", topK: false, type: "enhanced"},
            {name: "Cerebelum_Crus2_L", mni: [-12, -82, -34], activation: 0.0, importance: 0.001, network: "cerebellar", topK: false, type: "neutral"},
            {name: "Cerebelum_Crus2_R", mni: [14, -82, -34], activation: 0.391, importance: 0.014, network: "cerebellar", topK: false, type: "enhanced"},
            {name: "Amygdala_L", mni: [-22, -4, -18], activation: 0.080, importance: 0.015, network: "limbic", topK: true, type: "enhanced"},
            {name: "Amygdala_R", mni: [24, -4, -18], activation: 0.0, importance: 0.001, network: "limbic", topK: false, type: "neutral"},
            {name: "Hippocampus_L", mni: [-26, -18, -16], activation: 0.0, importance: 0.247, network: "limbic", topK: true, type: "suppressed"},
            {name: "Hippocampus_R", mni: [28, -18, -16], activation: 0.0, importance: 0.001, network: "limbic", topK: false, type: "neutral"},
            {name: "ParaHippocampal_L", mni: [-24, -26, -18], activation: 0.120, importance: 0.019, network: "limbic", topK: true, type: "enhanced"},
            {name: "ParaHippocampal_R", mni: [26, -26, -18], activation: 0.0, importance: 0.001, network: "limbic", topK: false, type: "neutral"},
            {name: "Thalamus_L", mni: [-8, -16, 8], activation: 0.055, importance: 0.011, network: "subcortical", topK: true, type: "enhanced"},
            {name: "Thalamus_R", mni: [10, -16, 8], activation: 0.0, importance: 0.082, network: "subcortical", topK: true, type: "suppressed"},
            {name: "Putamen_L", mni: [-24, 2, 2], activation: 0.0, importance: 0.134, network: "subcortical", topK: true, type: "suppressed"},
            {name: "Putamen_R", mni: [26, 2, 2], activation: -0.386, importance: 0.009, network: "subcortical", topK: false, type: "suppressed"}
        ];

        // Three.js setup
        let scene, camera, renderer, controls;
        let brainMesh, regionGroup;
        let selectedRegion = null;
        
        // Settings
        let settings = {
            brainOpacity: 0.1,
            regionSize: 1.0,
            glowIntensity: 1.0,
            showBrainMesh: true,
            showTopKOnly: true,
            showConnections: false,
            autoRotate: false,
            colorMode: 'activation'
        };

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000011);
            scene.fog = new THREE.Fog(0x000011, 100, 400);

            // Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 150);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('brain3d').appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 50;
            controls.maxDistance = 300;

            // Lighting
            setupLighting();
            
            // Create brain
            createRealisticBrain();
            
            // Create regions
            createBrainRegions();
            
            // Setup controls
            setupUIControls();
            
            // Start animation
            animate();
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
        }

        function setupLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            // Directional lights
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(100, 100, 100);
            light1.castShadow = true;
            light1.shadow.mapSize.width = 2048;
            light1.shadow.mapSize.height = 2048;
            scene.add(light1);

            const light2 = new THREE.DirectionalLight(0x4444ff, 0.3);
            light2.position.set(-100, -100, -100);
            scene.add(light2);

            // Point lights for regions
            const pointLight = new THREE.PointLight(0xffffff, 0.5, 200);
            pointLight.position.set(0, 0, 50);
            scene.add(pointLight);
        }

        function createRealisticBrain() {
            // Create brain surface mesh
            const brainGeometry = new THREE.SphereGeometry(70, 64, 32);
            
            // Deform sphere to be more brain-like
            const positions = brainGeometry.attributes.position;
            for (let i = 0; i < positions.count; i++) {
                const vertex = new THREE.Vector3();
                vertex.fromBufferAttribute(positions, i);
                
                // Add brain-like deformations
                const lat = Math.asin(vertex.y / vertex.length());
                const lon = Math.atan2(vertex.z, vertex.x);
                
                // Frontal lobe extension
                if (vertex.y > 0 && vertex.x > 0) {
                    vertex.multiplyScalar(1.1);
                }
                
                // Occipital lobe
                if (vertex.y < 0 && vertex.z < 0) {
                    vertex.multiplyScalar(0.9);
                }
                
                // Temporal lobes
                if (Math.abs(vertex.x) > 40 && vertex.y > -20 && vertex.y < 20) {
                    vertex.multiplyScalar(1.05);
                }
                
                positions.setXYZ(i, vertex.x, vertex.y, vertex.z);
            }
            positions.needsUpdate = true;
            brainGeometry.computeVertexNormals();

            // Brain material with realistic appearance
            const brainMaterial = new THREE.MeshPhongMaterial({
                color: 0xcccccc,
                transparent: true,
                opacity: settings.brainOpacity,
                shininess: 30,
                specular: 0x222222
            });

            brainMesh = new THREE.Mesh(brainGeometry, brainMaterial);
            brainMesh.receiveShadow = true;
            scene.add(brainMesh);

            // Add brain texture/details
            addBrainDetails();
        }

        function addBrainDetails() {
            // Add some brain surface details (sulci and gyri)
            const detailGroup = new THREE.Group();
            
            // Create some curved lines to represent sulci
            const sulciPaths = [
                // Central sulcus
                {start: [-20, 60, 10], end: [-20, -40, 50], color: 0x444444},
                {start: [20, 60, 10], end: [20, -40, 50], color: 0x444444},
                // Lateral sulcus
                {start: [-60, 20, -10], end: [-30, -30, 30], color: 0x444444},
                {start: [60, 20, -10], end: [30, -30, 30], color: 0x444444},
            ];

            sulciPaths.forEach(path => {
                const curve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(...path.start),
                    new THREE.Vector3(...path.end)
                ]);
                
                const geometry = new THREE.TubeGeometry(curve, 20, 1, 8);
                const material = new THREE.MeshBasicMaterial({ 
                    color: path.color, 
                    transparent: true, 
                    opacity: 0.3 
                });
                
                const sulcus = new THREE.Mesh(geometry, material);
                detailGroup.add(sulcus);
            });

            scene.add(detailGroup);
        }

        function createBrainRegions() {
            regionGroup = new THREE.Group();
            
            brainRegions.forEach((region, index) => {
                // Skip non-topK regions if filter is on
                if (settings.showTopKOnly && !region.topK) return;
                
                // Create region sphere
                const geometry = new THREE.SphereGeometry(2, 16, 16);
                
                // Get color based on mode
                const color = getRegionColor(region);
                
                // Create glowing material
                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: new THREE.Color(color).multiplyScalar(0.3),
                    transparent: true,
                    opacity: 0.9
                });

                const regionSphere = new THREE.Mesh(geometry, material);
                
                // Position using MNI coordinates (scaled)
                regionSphere.position.set(
                    region.mni[0] * 0.8,
                    region.mni[2] * 0.8,  // Z becomes Y (up)
                    -region.mni[1] * 0.8  // Y becomes -Z (depth)
                );
                
                // Scale based on importance
                const scale = 0.5 + (Math.abs(region.importance) / 3.0) * 2.0;
                regionSphere.scale.setScalar(scale * settings.regionSize);
                
                // Add glow effect for important regions
                if (region.topK) {
                    const glowGeometry = new THREE.SphereGeometry(3, 16, 16);
                    const glowMaterial = new THREE.MeshBasicMaterial({
                        color: 0xffd700,
                        transparent: true,
                        opacity: 0.2
                    });
                    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                    glow.scale.setScalar(scale * 1.5);
                    regionSphere.add(glow);
                }
                
                // Store region data
                regionSphere.userData = region;
                regionSphere.userData.index = index;
                
                // Add click interaction
                regionSphere.callback = () => selectRegion(region);
                
                regionGroup.add(regionSphere);
            });
            
            scene.add(regionGroup);
        }

        function getRegionColor(region) {
            switch (settings.colorMode) {
                case 'activation':
                    if (region.type === 'enhanced') return 0xff4444;
                    if (region.type === 'suppressed') return 0x4444ff;
                    return 0x888888;
                    
                case 'importance':
                    const intensity = Math.min(Math.abs(region.importance) / 3.0, 1.0);
                    return new THREE.Color().setHSL(0.3 * (1-intensity), 1, 0.5);
                    
                case 'network':
                    const networkColors = {
                        'sensorimotor': 0x00ff00,
                        'cognitive_control': 0x0000ff,
                        'visual': 0xffa500,
                        'cerebellar': 0xff0000,
                        'limbic': 0xff00ff,
                        'subcortical': 0x00ffff,
                        'attention': 0xffff00,
                        'auditory': 0xff8000
                    };
                    return networkColors[region.network] || 0x888888;
                    
                case 'statistical':
                    // Mock p-values based on importance
                    const pValue = Math.max(0.001, 0.1 - Math.abs(region.importance) * 0.03);
                    if (pValue < 0.001) return 0xff0000;
                    if (pValue < 0.01) return 0xff8800;
                    if (pValue < 0.05) return 0xffff00;
                    return 0x888888;
                    
                default:
                    return 0x888888;
            }
        }

        function selectRegion(region) {
            selectedRegion = region;
            updateRegionInfo();
            
            // Highlight selected region
            regionGroup.children.forEach(child => {
                if (child.userData.name === region.name) {
                    child.material.emissive.setHex(0x444444);
                } else {
                    const color = getRegionColor(child.userData);
                    child.material.emissive = new THREE.Color(color).multiplyScalar(0.3);
                }
            });
        }

        function updateRegionInfo() {
            if (!selectedRegion) return;
            
            const info = document.getElementById('selectedRegion');
            const activationType = selectedRegion.type === 'enhanced' ? 'Enhanced during pain' : 
                                 selectedRegion.type === 'suppressed' ? 'Suppressed during pain' : 'Neutral';
            
            info.innerHTML = `
                <h4>${selectedRegion.name.replace(/_/g, ' ')}</h4>
                <p><strong>Network:</strong> ${selectedRegion.network.replace(/_/g, ' ')}</p>
                <p><strong>MNI Coordinates:</strong> [${selectedRegion.mni.join(', ')}]</p>
                <p><strong>Activation:</strong> ${selectedRegion.activation > 0 ? '+' : ''}${selectedRegion.activation.toFixed(6)}</p>
                <p><strong>Importance:</strong> ${selectedRegion.importance.toFixed(3)}</p>
                <p><strong>Type:</strong> ${activationType}</p>
                <p><strong>Top-K:</strong> ${selectedRegion.topK ? '‚úÖ Selected' : '‚ùå Not selected'}</p>
            `;
        }

        function setupUIControls() {
            // Brain opacity
            document.getElementById('brainOpacity').addEventListener('input', (e) => {
                settings.brainOpacity = parseFloat(e.target.value);
                if (brainMesh) {
                    brainMesh.material.opacity = settings.brainOpacity;
                }
            });

            // Region size
            document.getElementById('regionSize').addEventListener('input', (e) => {
                settings.regionSize = parseFloat(e.target.value);
                updateRegions();
            });

            // Show brain mesh
            document.getElementById('showBrainMesh').addEventListener('change', (e) => {
                settings.showBrainMesh = e.target.checked;
                if (brainMesh) {
                    brainMesh.visible = settings.showBrainMesh;
                }
            });

            // Show top-K only
            document.getElementById('showTopKOnly').addEventListener('change', (e) => {
                settings.showTopKOnly = e.target.checked;
                recreateRegions();
            });

            // Auto rotate
            document.getElementById('autoRotate').addEventListener('change', (e) => {
                settings.autoRotate = e.target.checked;
                controls.autoRotate = settings.autoRotate;
            });

            // Color mode
            document.querySelectorAll('input[name="colorMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    settings.colorMode = e.target.value;
                    updateRegions();
                });
            });

            // Mouse interaction
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            renderer.domElement.addEventListener('click', (event) => {
                event.preventDefault();
                
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(regionGroup.children);

                if (intersects.length > 0) {
                    const region = intersects[0].object.userData;
                    selectRegion(region);
                }
            });
        }

        function updateRegions() {
            regionGroup.children.forEach(child => {
                const region = child.userData;
                
                // Update color
                const color = getRegionColor(region);
                child.material.color.setHex(color);
                child.material.emissive = new THREE.Color(color).multiplyScalar(0.3);
                
                // Update size
                const scale = 0.5 + (Math.abs(region.importance) / 3.0) * 2.0;
                child.scale.setScalar(scale * settings.regionSize);
            });
        }

        function recreateRegions() {
            scene.remove(regionGroup);
            createBrainRegions();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            
            // Animate region glow
            const time = Date.now() * 0.001;
            regionGroup.children.forEach(child => {
                if (child.userData.topK) {
                    const glow = child.children[0];
                    if (glow) {
                        glow.material.opacity = 0.1 + 0.1 * Math.sin(time * 2 + child.userData.index);
                    }
                }
            });
            
            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize when Three.js is loaded
        window.addEventListener('load', () => {
            if (typeof THREE !== 'undefined') {
                init();
            } else {
                document.getElementById('loading').innerHTML = '<p>‚ùå Failed to load 3D library. Please check your internet connection.</p>';
            }
        });
    </script>
</body>
</html>